def lower_bound(arr, target):
    l, r = 0, len(arr)
    while l < r:
        mid = (l + r) // 2
        if arr[mid] < target:
            l = mid + 1
        else:
            r = mid
    return l

def insert_sorted(arr, x):
    idx = lower_bound(arr, x)
    arr.insert(idx, x)

class Solution:
    def maxSumSubmatrix(self, matrix, k):
        m, n = len(matrix), len(matrix[0])
        ans = float('-inf')

        if m > n:
            matrix = list(zip(*matrix))
            m, n = n, m

        for left in range(n):
            sums = [0] * m
            for right in range(left, n):
                for i in range(m):
                    sums[i] += matrix[i][right]

                prefix = 0
                prefix_sums = [0]

                for x in sums:
                    prefix += x
                    # tÃ¬m y >= prefix - k
                    idx = lower_bound(prefix_sums, prefix - k)
                    if idx < len(prefix_sums):
                        ans = max(ans, prefix - prefix_sums[idx])
                    insert_sorted(prefix_sums, prefix)

        return ans
